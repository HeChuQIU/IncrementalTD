# Feature Specification: 建筑系统 (Building System)

**Feature Branch**: `001-building-system`  
**Created**: 2026-02-25  
**Status**: Draft  
**Input**: User description: "创建建筑系统。建筑基于地砖层。建筑具有矩形大小，（有的建筑）可以旋转。现有的防御塔也是建筑。建筑系统中包含一个注册表，目前只支持代码注册，但是可以通过代码方式和游戏内控制台命令查询。有些建筑具有放置条件。有些建筑具有内部物品存储。添加钻机建筑。2x2，必须放置在矿石上（有一格即可），可以自动生成矿石。添加铜矿石地砖。矿石地砖不会因为开采而枯竭。开发完成后需要一个场景用于验证。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 建筑注册表查询 (Priority: P1)

开发者/玩家希望通过游戏内控制台输入命令，查看当前已注册的所有建筑类型，以便了解游戏中可用的建筑。

**Why this priority**: 注册表是整个建筑系统的基础。在能放置建筑之前，必须能查询可用建筑类型；同时这也是最低开销的验证方式，可以在其他功能尚未完成时独立验证。

**Independent Test**: 只需注册至少一种建筑（如防御塔），然后在控制台执行查询命令，即可独立验证此功能。

**Acceptance Scenarios**:

1. **Given** 游戏已运行，**When** 玩家在控制台输入建筑列表查询命令，**Then** 控制台返回所有已注册建筑的名称、大小及是否可旋转等基本信息。
2. **Given** 注册表中有多种建筑，**When** 玩家按名称查询指定建筑，**Then** 控制台返回该建筑的详细信息（名称、大小、是否可旋转、是否有放置条件、是否有物品存储）。
3. **Given** 查询了一个不存在的建筑名称，**When** 执行查询命令，**Then** 控制台给出明确的"未找到"提示。

---

### User Story 2 - 铜矿石地砖与钻机放置 (Priority: P2)

玩家希望在地图上存在铜矿石地砖，并能将 2x2 的钻机建筑放置在含有矿石地砖的区域，使钻机自动产出铜矿石资源。

**Why this priority**: 铜矿石地砖和钻机是本次需求的核心业务功能，代表完整的"资源采集"游戏循环。依赖建筑系统基础（P1）搭建后即可实现。

**Independent Test**: 在验证场景中预先放置铜矿石地砖，然后执行放置钻机的操作（通过控制台命令或代码驱动），观察钻机是否正常放置并开始产出物品。

**Acceptance Scenarios**:

1. **Given** 地图上存在铜矿石地砖，**When** 玩家尝试将钻机放置在覆盖至少一格铜矿石地砖的 2x2 区域，**Then** 放置成功，钻机在该位置生成。
2. **Given** 钻机已放置在矿石地砖上，**When** 经过一段游戏时间，**Then** 钻机内部物品存储中出现铜矿石物品，产出持续进行。
3. **Given** 钻机持续采矿，**When** 检查铜矿石地砖状态，**Then** 铜矿石地砖外观和属性不受任何影响（不枯竭、不消失）。
4. **Given** 待放置区域没有任何矿石地砖，**When** 玩家尝试在此处放置钻机，**Then** 放置被拒绝，并给出原因提示（放置条件不满足）。

---

### User Story 3 - 现有防御塔纳入建筑系统 (Priority: P3)

已有的防御塔功能应无缝融入新的建筑系统，不破坏现有游戏逻辑。

**Why this priority**: 此故事保证向后兼容性。防御塔本身功能不变，但作为建筑实体接受统一管理，降低重构风险。

**Independent Test**: 运行现有游戏或测试场景，确认防御塔的攻击、瞄准等行为与重构前一致，并可通过建筑注册表查询到防御塔定义。

**Acceptance Scenarios**:

1. **Given** 建筑系统已初始化，**When** 通过建筑注册表查询防御塔，**Then** 能查询到防御塔的建筑定义。
2. **Given** 游戏中已放置了防御塔，**When** 游戏运行，**Then** 防御塔的攻击和伤害行为与引入建筑系统之前完全一致。

---

### User Story 4 - 验证场景 (Priority: P4)

开发者需要一个独立的验证场景，在其中可以直观地确认整个建筑系统——包括矿石地砖、钻机放置与产出——均正确工作。

**Why this priority**: 验证场景是所有功能实现后的最终确认手段，在其他用户故事完成后方可实施，优先级最低。

**Independent Test**: 启动验证场景，场景自动或通过控制台命令完成所有验证动作，无异常则通过。

**Acceptance Scenarios**:

1. **Given** 验证场景已启动，**When** 场景初始化完成，**Then** 场景中包含铜矿石地砖、已放置的钻机以及可操作的控制台。
2. **Given** 验证场景运行，**When** 玩家（或开发者）观察场景，**Then** 能够直观确认：钻机正在产出矿石、矿石地砖未枯竭、建筑信息可从控制台查询。

---

### Edge Cases

- 当 2x2 的钻机放置区域有部分超出地图边界时，应拒绝放置并提示原因。
- 当目标位置已存在其他建筑时，不允许重叠放置，应拒绝并提示。
- 当钻机内部物品存储已满时，钻机暂停产出，待存储有空间后自动恢复。
- 旋转后的建筑，其占地宽高（格数）在坐标系中互换（宽变高、高变宽）。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须提供统一的建筑定义结构，包含名称（唯一标识）、占地宽/高（格数）、是否可旋转、可选的放置条件列表、可选的物品存储容量。
- **FR-002**: 系统必须包含建筑注册表，支持在代码中注册建筑定义；同一名称不可重复注册。
- **FR-003**: 系统必须允许通过代码 API 查询注册表（按名称精确查询、列出全部）。
- **FR-004**: 系统必须允许通过游戏内控制台命令查询注册表（列出全部或按名称查询）。
- **FR-005**: 现有防御塔类型必须以建筑定义的形式注册到建筑注册表中，且其游戏行为不受影响。
- **FR-006**: 可旋转建筑在旋转时，其占地宽高互换；非可旋转建筑无旋转状态。
- **FR-007**: 建筑放置时必须校验目标区域内所有格子均在地图范围内，越界则拒绝并给出提示。
- **FR-008**: 建筑放置时必须校验目标区域不与已存在的建筑占地重叠，重叠则拒绝并给出提示。
- **FR-009**: 具有放置条件的建筑，放置前必须对目标区域的地砖进行条件校验；条件不满足则拒绝放置并给出原因说明。
- **FR-010**: 系统必须提供铜矿石地砖类型；铜矿石地砖在任何情况下不因采矿操作而枯竭或状态发生变化。
- **FR-011**: 系统必须提供钻机建筑定义：占地 2×2、具有放置条件（至少一格位于矿石地砖上）、具有内部物品存储、可自动周期性产出对应矿石物品存入内部存储。
- **FR-012**: 钻机内部物品存储满时，钻机暂停产出；存储有空间后自动恢复产出。
- **FR-013**: 必须提供供开发者使用的验证场景，包含铜矿石地砖分布、可放置钻机的操作入口（控制台命令或代码触发）、产出结果可视化展示。

### Key Entities

- **BuildingDefinition（建筑定义）**: 描述一种建筑类型的不可变元数据，包含名称、占地宽/高、是否可旋转、可选的放置条件列表、可选的物品存储容量。
- **BuildingRegistry（建筑注册表）**: 全局唯一的注册中心，存储所有已注册的建筑定义，提供注册、按名查询、列举全部的方法。
- **PlacedBuilding（已放置建筑实例）**: 地图上实际存在的建筑，包含所属定义引用、占据的地砖坐标集合、当前旋转状态、可选的物品存储实例。
- **PlacementCondition（放置条件）**: 附加到建筑定义上的规则，接受目标格子集合，返回是否满足及原因文本。
- **ItemStorage（物品存储）**: 建筑内部的物品库，包含容量上限和当前持有的物品列表，满仓时拒绝新增。
- **OreItem（矿石物品）**: 由钻机产出并存入物品存储的资源物品，类型由覆盖的矿石地砖类型决定。
- **OreTile（矿石地砖）**: 地砖的一种，标记该格含有特定矿石，永不枯竭且状态不随采矿变化。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 通过控制台命令可在 1 秒内查询到注册的全部建筑类型列表。
- **SC-002**: 钻机在满足放置条件时 100% 可成功放置；不满足条件时 100% 被拒绝并给出原因说明。
- **SC-003**: 钻机放置后，在一个产出周期内自动开始向内部存储添加矿石物品，无需人工干预。
- **SC-004**: 铜矿石地砖在钻机持续工作 10 个产出周期后，与初始状态完全一致（无枯竭、无消失）。
- **SC-005**: 现有防御塔相关的所有已有测试用例在引入建筑系统后继续通过，零回归。
- **SC-006**: 验证场景可在不超过 30 秒的操作流程内，演示完整的"放置钻机 → 产出矿石 → 查询建筑信息"游戏循环。

## Assumptions

- 建筑的美术资源（精灵图、动画）不在本次规格范围内；渲染采用**调试模式**：以带边框的矩形覆盖建筑占地格子，矩形内用中文文字显示建筑名称和当前状态（如存储量、产出计时等），验证场景同理。
- 物品从钻机存储中取出（运输、消耗）属于后续功能，本次只需实现产出并存入内部存储。
- 钻机产出速率采用合理的游戏默认值，具体数值在实现阶段确定，规格不固定具体数字。
- 建筑放置的完整 UI 交互（玩家点击格子拖拽建造）属于后续功能；验证场景通过控制台命令或代码触发放置即可。
- 每种矿石地砖对应一种矿石物品；铜矿石地砖产出铜矿石物品。
- 防御塔作为建筑纳入系统时，其1x1占地的假设在实现阶段确认，如需调整以不破坏现有测试为准。
