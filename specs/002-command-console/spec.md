# 功能规格：命令系统与游戏内控制台

**功能分支**: `002-command-console`  
**创建日期**: 2026-02-24  
**状态**: 草稿  
**输入**: 编写一套命令系统，以及配套的游戏内控制台，支持智能补全、目标高亮、实体放置与运行反馈，风格类《我的世界》

## 用户场景与测试

### 用户故事 1 - 呼出控制台并执行命令 (优先级: P1)

玩家在游戏中按下反引号键（`` ` ``）呼出控制台，在输入框中键入命令（例如 `/spawn enemy goblin 5 3`），按下回车执行命令，控制台随即显示执行结果（成功或错误信息）。按 ESC 键可关闭控制台并返回游戏。

**为何此优先级**: 这是整个功能的基础，没有可用的输入/输出界面，其他所有功能均无法建立。

**独立测试**: 仅实现命令解析与文本输出，即可测试：呼出 → 输入 → 执行 → 查看反馈 → 关闭控制台的基础闭环。

**验收场景**:

1. **前提** 游戏正在运行，控制台未显示，**当** 玩家按下反引号键，**则** 控制台出现在屏幕下方，输入框获取焦点，游戏暂停接受键盘输入
2. **前提** 控制台已打开，玩家输入了有效命令，**当** 玩家按下回车，**则** 命令被执行，控制台追加一条成功反馈消息，输入框清空
3. **前提** 控制台已打开，玩家输入了无效命令，**当** 玩家按下回车，**则** 控制台追加一条红色错误消息，描述错误原因
4. **前提** 控制台已打开，**当** 玩家按下 ESC，**则** 控制台关闭，游戏恢复正常键盘响应

---

### 用户故事 2 - 智能补全辅助输入 (优先级: P1)

玩家在输入框中键入命令或参数前缀时，控制台自动显示补全候选列表。候选项基于当前输入位置的期望类型（命令名称、实体类型、坐标等），前缀不匹配的候选项自动过滤。玩家可用 Tab 键或方向键选中候选，回车确认。

**为何此优先级**: 智能补全显著降低命令记忆门槛，是使控制台"可用"而非"可知"的关键，对高级玩家和调试均意义重大。

**独立测试**: 可独立测试：对每种参数类型（命令、实体类型、坐标）输入部分前缀，验证候选列表是否正确、选中后是否正确填入。

**验收场景**:

1. **前提** 控制台已打开，输入框为空，**当** 玩家键入 `/sp`，**则** 候选列表显示所有以 `sp` 开头的命令名称
2. **前提** 玩家已输入 `/spawn`，光标在第二个参数位置（期望类型为实体类别），**当** 玩家键入 `en`，**则** 候选列表只显示实体类别中以 `en` 开头的选项（如 `enemy`）
3. **前提** 玩家已输入 `/spawn enemy`，光标在第三个参数（期望类型为实体子类型，如敌人名称），**当** 玩家键入 `gob`，**则** 候选列表显示以 `gob` 开头的敌人名称（如 `goblin`）
4. **前提** 补全候选列表已显示，**当** 玩家按 Tab 键，**则** 输入框自动填入第一个候选项
5. **前提** 候选列表已显示，**当** 玩家按下方向键选中某项后按回车，**则** 该候选项被填入输入框

---

### 用户故事 3 - 目标高亮 (优先级: P2)

玩家在输入涉及坐标或实体引用的参数时，游戏画面中的对应地砖或实体会实时高亮显示，让玩家直观确认操作目标，避免误操作。

**为何此优先级**: 高亮功能提升了命令输入的安全感和直观性，尤其在涉及地图编辑时价值突出，但不影响功能主流程。

**独立测试**: 可独立测试：输入坐标参数组合，验证对应地砖是否高亮；输入实体 ID 时验证对应实体是否高亮。

**验收场景**:

1. **前提** 玩家在输入包含坐标参数的命令，**当** 坐标参数（如 `5 3`）合法且完整，**则** 游戏地图上对应坐标的地砖显示高亮边框
2. **前提** 玩家修改了坐标参数为另一组坐标，**当** 新坐标合法，**则** 高亮立即转移到新位置
3. **前提** 玩家输入了实体 ID 参数，**当** 该实体存在于场景中，**则** 该实体在游戏画面中显示高亮
4. **前提** 控制台关闭或输入框清空，**当** 控制台关闭或参数被删除，**则** 所有高亮消失，游戏画面恢复正常

---

### 用户故事 4 - 放置与编辑实体/地砖 (优先级: P2)

玩家通过命令在指定坐标放置敌人、防御塔等实体，或修改指定坐标的地砖类型。命令执行后，游戏场景实时反映变化。

**为何此优先级**: 这是控制台核心的实际游戏操作能力，也是调试和高级玩家体验的主要价值所在。

**独立测试**: 可分别测试放置命令（验证场景内出现对应实体）和地砖编辑命令（验证地砖类型变更），各自独立验证。

**验收场景**:

1. **前提** 游戏场景已加载，**当** 玩家执行 `/spawn enemy goblin 5 3`，**则** 坐标 (5, 3) 处出现一只哥布林敌人，控制台显示成功消息
2. **前提** 游戏场景已加载，**当** 玩家执行 `/spawn tower archer 4 2`，**则** 坐标 (4, 2) 处放置一座弓箭手防御塔
3. **前提** 游戏场景已加载，**当** 玩家执行放置命令但目标坐标超出地图边界，**则** 命令失败并显示边界越界错误
4. **前提** 游戏场景已加载，**当** 玩家执行地砖编辑命令（如 `/tile set 3 3 wall`），**则** 坐标 (3, 3) 的地砖类型变更为墙，路径系统相应更新
5. **前提** 地砖命令执行后，**当** 涉及寻路区域被修改，**则** 敌人寻路路径实时重新计算

---

### 用户故事 5 - 历史记录与调试辅助 (优先级: P3)

玩家可以通过上下方向键（在输入框中）调出历史执行过的命令，便于重复操作或微调参数。控制台消息分颜色区分输入、成功和错误。

**为何此优先级**: 便利性功能，不影响核心流程，但提升了高级玩家和开发调试的体验效率。

**独立测试**: 可独立测试：执行若干命令后，按上方向键依次回溯历史命令是否正确回填。

**验收场景**:

1. **前提** 玩家已执行过 3 条命令，**当** 在输入框中按上方向键，**则** 最近一条历史命令填入输入框
2. **前提** 控制台显示多条消息，**当** 查看消息列表，**则** 输入命令显示为白色，成功反馈显示为绿色，错误信息显示为红色
3. **前提** 控制台消息数量超过可视区域，**当** 有新消息，**则** 消息列表自动滚动到最新消息

---

### 边缘情况

- 玩家输入命令名称不存在时，是否给出最近似的命令建议？（默认：仅显示"未知命令"，不推断）
- 坐标参数输入中途（不完整）时，高亮行为如何？（默认：坐标不完整时不高亮，等待完整输入）
- 游戏暂停/结束状态下呼出控制台时，某些命令是否需要限制？（默认：游戏暂停状态下允许所有控制台命令）
- 连续快速执行多条命令时，场景更新是否正确？（默认：命令依次同步执行，每条命令执行后触发场景刷新）
- 控制台打开时，游戏快捷键是否应该被拦截？（默认：是，控制台打开时所有游戏输入被阻断，`ESC` 除外）

## 需求规格

### 功能需求

- **FR-001**: 系统必须支持通过反引号键（`` ` ``）打开/关闭控制台 UI
- **FR-002**: 系统必须支持通过 ESC 键关闭控制台，不执行任何命令
- **FR-003**: 控制台打开期间，系统必须拦截所有游戏键盘输入（ESC 除外）
- **FR-004**: 控制台 UI 必须具有半透明深色背景，叠加在游戏画面上方
- **FR-005**: 控制台必须包含可滚动的消息历史区域和底部单行输入框
- **FR-006**: 消息历史区域必须按类型为消息着色：用户输入（白色）、成功（绿色）、错误（红色）
- **FR-007**: 系统必须维护命令历史记录，玩家可通过上/下方向键在输入框中回溯历史命令
- **FR-008**: 系统必须在玩家输入时实时显示基于前缀的补全候选列表
- **FR-009**: 补全候选项必须根据当前输入位置的参数期望类型（命令名称、实体类别、坐标等）进行过滤
- **FR-010**: 玩家必须能通过 Tab 键快速填入第一个候选项，或通过方向键+回车选中指定候选项
- **FR-011**: 当参数期望类型为坐标且当前输入包含合法完整坐标时，系统必须在游戏地图上高亮对应地砖
- **FR-012**: 当参数涉及实体引用（如实体 ID）且该实体存在时，系统必须高亮该实体
- **FR-013**: 控制台关闭或相关参数被清空时，系统必须移除所有高亮效果
- **FR-014**: 系统必须支持 `/spawn <实体类别> <实体子类型> <x> <y>` 命令，在指定坐标生成实体
- **FR-015**: 系统必须支持 `/tile set <x> <y> <地砖类型>` 命令，修改指定坐标的地砖类型
- **FR-016**: 命令执行后，系统必须在控制台追加一条包含执行结果的反馈消息
- **FR-017**: 命令执行失败时，反馈消息必须描述失败原因（如越界、实体类型无效等）
- **FR-018**: 地砖类型修改后，系统必须触发寻路路径的重新计算

### 核心实体

- **命令（Command）**: 命令名称、参数定义列表（含每个参数的期望类型和说明）、执行处理函数
- **参数类型（ParameterType）**: 描述一类参数的可选值或输入规则（如 `坐标`、`实体类别`、`实体子类型`、`地砖类型`）
- **控制台消息（ConsoleMessage）**: 消息内容、消息类型（input / success / error）
- **命令历史（CommandHistory）**: 历史命令字符串列表，支持前进/后退导航
- **补全候选（CompletionItem）**: 候选文字、说明/提示

## 成功标准

### 可量化指标

- **SC-001**: 玩家从按下反引号键到控制台输入框可接受输入，响应时间在 100 毫秒以内
- **SC-002**: 输入中任意位置按 Tab 键，补全候选列表出现且填入，整体耗时在 50 毫秒以内
- **SC-003**: 所有已注册的命令均需有补全候选，无已知命令出现"无候选"情况
- **SC-004**: 坐标参数输入完整后，目标地砖高亮在下一帧（约 16ms）内出现
- **SC-005**: `/spawn` 和 `/tile set` 命令执行后，场景变化在当前帧刷新中即可见
- **SC-006**: 控制台消息区域可容纳至少 50 条历史消息，并支持向上滚动查看
- **SC-007**: 命令历史至少保存最近 20 条记录，按上键可依次回溯
- **SC-008**: 错误命令不会导致游戏崩溃或不可恢复的状态，始终有错误反馈消息

## 假设

- 坐标系采用游戏地图的格子坐标（整数 x, y），与屏幕像素坐标无关
- 控制台不支持多行命令或脚本批处理（每次执行单条命令）
- 实体子类型列表（如敌人名称、防御塔名称）从游戏内已注册的实体配置中动态读取，无需硬编码
- 补全候选列表最多显示 8 条，超出部分忽略（不分页）
- 控制台不持久化历史记录到存档，仅在本次游戏会话中有效

## 技术选型

> 经调研确认，npm 生态无开箱即用的游戏内命令控制台方案，采用以下分层组合策略：

| 层次 | 选用库 | 理由 |
|------|--------|------|
| **UI 层** | `phaser3-rex-plugins` | 原生 Phaser 3，`BBCodeText` 支持 `[color]` 颜色标签，`UI/ScrollablePanel` 提供滚动消息历史，`CanvasInput` 处理键盘输入（含中文输入法），覆盖 ~60% UI 工作量 |
| **命令解析层** | `commander`（浏览器模式）| 26k Stars，命令注册/参数定义/分发均完善，TypeScript 强类型，使用 `.exitOverride()` 适配浏览器，覆盖 ~40% 命令系统工作量 |
| **自行实现** | — | 命令历史导航、类型感知 Tab 补全逻辑、补全候选浮层 UI、地砖/实体高亮（Phaser `Graphics` overlay） |
